# Анализ приложения и исправления стабильности

## Найденные и исправленные баги

### 1. **Двойная отправка RESULTS (критично)**
- **Проблема:** При нажатии ведущим «Показать ответ» вызывался `finishQuestion`, но таймер вопроса не отменялся. Когда таймер срабатывал, `finishQuestion` вызывался повторно — клиенты получали два события RESULTS подряд.
- **Исправление:** В обработчике `SHOW_RESULTS` перед вызовом `finishQuestion` вызывается `clearTimeout(room.currentTimer)` и обнуление `room.currentTimer`.

### 2. **Валидация ответа игрока (choice)**
- **Проблема:** Для вопроса с выбором (A/B/C/D) сервер не проверял, что `answerIndex` — целое число в допустимом диапазоне. Можно было отправить произвольное число.
- **Исправление:** Проверка `Number.isInteger(idx)`, `idx >= 0` и `idx < opts.length` перед записью ответа.

### 3. **Отсутствие проверки текущего вопроса**
- **Проблема:** В `SUBMIT_ANSWER` не проверялось наличие `room.questions[room.currentQuestionIndex]` — при сбоях могло быть обращение к `undefined`.
- **Исправление:** Добавлена проверка `if (!q) return;` перед обработкой ответа.

### 4. **Path traversal в API паков**
- **Проблема:** В `GET /api/packs/:id` и `POST /api/packs` параметр `id` мог содержать `../` или другие символы и использоваться в пути к файлу — риск чтения/записи вне папки `games`.
- **Исправление:** Введена функция `sanitizePackId(id)` (латиница, цифры, дефис, подчёркивание; длина до 64). Все обращения к файлам паков используют только `sanitizePackId`.

### 5. **Падение списка паков из‑за одного битого файла**
- **Проблема:** В `GET /api/packs` при ошибке парсинга одного JSON весь запрос возвращал 500, остальные паки не отдавались.
- **Исправление:** Обход файлов в цикле с try/catch по каждому файлу; битые паки пропускаются с записью в `console.error`, в ответ попадают только успешно загруженные.

### 6. **«Призрачные» комнаты**
- **Проблема:** Если ведущий на одной вкладке дважды нажимал «Создать комнату» (или переподключался), создавалась вторая комната, а старая оставалась в памяти без ведущего.
- **Исправление:** В `CREATE_ROOM` при создании новой комнаты проверяется, был ли сокет уже ведущим. Если да — у старой комнаты отменяется таймер и она удаляется из `rooms`.

### 7. **Таймер при отключении ведущего**
- **Проблема:** При отключении ведущего комната удалялась, но `room.currentTimer` не отменялся — таймер оставался в очереди до срабатывания (затем колбэк видел `getRoom(code) === undefined` и ничего не делал).
- **Исправление:** В обработчике `disconnect` для ведущего перед `rooms.delete(code)` вызывается `clearTimeout(room.currentTimer)`.

### 8. **Никнейм без ограничений**
- **Проблема:** Длина и содержание никнейма не ограничивались на сервере.
- **Исправление:** Никнейм обрезается до 30 символов; пустой после trim отклоняется с сообщением «Введите имя».

### 9. **getRoom при неверном code**
- **Проблема:** При `code === null` или не строке вызов `code?.toUpperCase()` мог приводить к неочевидному поведению.
- **Исправление:** В начале `getRoom` проверка `code == null || typeof code !== 'string'` с возвратом `undefined`.

---

## Улучшения клиента

### Host
- При событии `disconnect` сокета состояние сбрасывается в экран «Создать комнату» (очистка кода, URL, игроков, вопроса, результатов, таблицы лидеров), чтобы после обрыва связи ведущий не оставался на «мёртвом» экране.
- В списках (лобби, результаты, финальная таблица) ключи React сделаны стабильными: `key={\`${entry.nickname}-${i}\`}` или `i`, чтобы избежать предупреждений при совпадении имён.

### Client
- Аналогично стабильные ключи в списках результатов и финальной таблицы.

### Admin
- При редактировании пака запрос к `/api/packs/:id` использует `encodeURIComponent(pack.id)`.
- При ответе 404 или другом неуспешном ответе показывается сообщение «Пак не найден» или «Не удалось загрузить пак», без попытки парсить не-JSON.

### useSocket
- Подписка на `connect_error` и установка `connected = false`, чтобы UI корректно показывал отсутствие соединения.
- В cleanup отписка от `connect`, `disconnect`, `connect_error` перед `disconnect()`.

---

## Рекомендации на будущее

- **Reconnect игрока:** при обрыве связи восстанавливать сессию по сохранённому в localStorage roomCode + playerId (серверу понадобится хранение/восстановление состояния комнаты).
- **Лимиты:** максимальное число игроков в комнате, максимальное число комнат на процесс.
- **Таймаут неактивных комнат:** удалять комнаты, в которых давно не было активности (например, через 1–2 часа).
- **Валидация размера пака:** ограничить размер JSON при POST /api/packs (например, body-parser limit или проверка длины).

Все перечисленные исправления внесены в код; стабильность и предсказуемость приложения улучшены.
