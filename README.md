# Box Party Game

Локальная мультиплеерная платформа для викторин в стиле Jackbox: ПК — ведущий и сервер, игроки подключаются с телефонов через браузер.

## Стек

- **Сервер:** Node.js, Express, Socket.io
- **Клиент:** React, Tailwind CSS, Framer Motion
- **Язык интерфейса:** русский

## Запуск

### Быстрый запуск (Windows и Mac)

Самый простой способ — скрипт **start**, который сам установит зависимости (при первом запуске), соберёт клиент, запустит сервер и откроет браузер.

- **Windows:** дважды щёлкните по `start.bat` или в терминале: `node start.js`
- **macOS:** дважды щёлкните по `start.command` или в терминале: `node start.js`

Требуется [Node.js](https://nodejs.org/) (LTS). После запуска откроется главная страница; для ведущего перейдите на http://localhost:3000/host, для игроков — http://localhost:3000/client (с телефона подставьте ваш IP из консоли).

Остановка: закройте окно терминала или нажмите в нём Ctrl+C.

### Установка зависимостей

```bash
npm install
cd client && npm install && cd ..
```

### Режим разработки

Запустите сервер и клиент одновременно:

```bash
npm run dev
```

- Сервер: http://localhost:3000  
- Клиент (Vite): http://localhost:5173 (проксирует API и Socket.io на 3000)

Откройте в браузере:
- **Ведущий (ПК):** http://localhost:5173/host
- **Игрок (телефон):** с телефона в той же Wi‑Fi сети: http://**ВАШ_IP**:5173/client (или после сборки http://**ВАШ_IP**:3000/client)

### Продакшен (одна точка входа)

```bash
npm run build
npm run dev:server
```

После этого раздаётся только сервер на порту 3000. Открывайте:
- http://localhost:3000 (главная)
- http://localhost:3000/host
- http://localhost:3000/client
- http://localhost:3000/admin

**Для игры с телефонов:** замените `localhost` на локальный IP (например 192.168.1.x). IP выводится в консоли при старте сервера.

### Подключение с телефона

#### Подключение без туннеля (пошагово)

1. **Один раз настроить брандмауэр.** В папке проекта откройте папку `scripts` и **дважды щёлкните** по `add-firewall-rules.cmd` (появится запрос «Разрешить изменения» — нажмите «Да»). Либо откройте PowerShell **от имени администратора**, перейдите в папку проекта и выполните:
   ```powershell
   Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass -Force; .\scripts\add-firewall-rules.ps1
   ```
2. **Сделать Wi‑Fi «частной» сетью.** Параметры → Сеть и Интернет → Wi‑Fi → ваша сеть → «Профиль сети» → **Частная**.
3. **Собрать и запустить сервер:** `npm run build` и `npm run dev:server`. В консоли будет строка **«С телефона: http://192.168.x.x:3000»**.
4. **Проверка с ПК.** На самом ПК в браузере откройте этот адрес, например `http://192.168.0.19:3000/api/health`. Должен открыться ответ с `"ok":true`. Если на ПК по этому адресу не открывается — сервер слушает не на том интерфейсе (напишите в issue).
5. **С телефона** откройте в браузере **http://ВАШ_IP:3000/client** (тот же IP, что в консоли). Телефон должен быть в той же Wi‑Fi сети, что и ПК.
6. Если по-прежнему таймаут — попробуйте **точку доступа с ПК**: Параметры → Сеть и Интернет → Точка доступа для мобильных устройств → включить. Подключите телефон к этой Wi‑Fi. На телефоне откройте **http://192.168.137.1:3000/client**.

#### Если страница не загружается — проверка по шагам:

1. **Проверка доступности сервера.** На телефоне в браузере откройте **http://ВАШ_IP:3000/api/health** (подставьте IP из консоли, например http://192.168.0.19:3000/api/health).
   - Если видите `{"ok":true,"message":"Сервер доступен",...}` — сервер досягаем, значит проблема была с загрузкой SPA; попробуйте снова открыть http://ВАШ_IP:3000/client или http://ВАШ_IP:3000/.
   - Если страница не открывается (таймаут, «нет соединения») — блокирует **брандмауэр** или сеть.

2. **Брандмауэр Windows.** Разрешите входящие подключения для Node:
   - Параметры → Сеть и Интернет → Брандмауэр Windows → Разрешить приложение через брандмауэр → Изменить параметры → найдите **Node.js JavaScript Runtime** и отметьте **Частные** (и при необходимости Общедоступные). Сохраните.
   - Или в PowerShell **от имени администратора** выполните (разрешить для **всех** профилей сети — и частная, и общедоступная):
     ```powershell
     New-NetFirewallRule -DisplayName "Node 3000" -Direction Inbound -Protocol TCP -LocalPort 3000 -Action Allow -Profile Any
     ```
     Если правило «Node 3000» уже есть, сначала удалите:  
     `Remove-NetFirewallRule -DisplayName "Node 3000"`  
     затем создайте снова с `-Profile Any`.

3. **Профиль сети в Windows.** Если Wi‑Fi помечен как «Общедоступная сеть», правило с профилем «Частная» не сработает. Либо создайте правило с **-Profile Any** (см. выше), либо сделайте сеть частной: Параметры → Сеть и Интернет → Wi‑Fi → имя сети → «Профиль сети» → выберите **Частная**.

4. **Роутер.** У некоторых роутеров включена «изоляция клиентов» (AP isolation). Два варианта обхода:
   - **Точка доступа с телефона:** телефон раздаёт Wi‑Fi, ПК подключается к нему. В консоли сервера смотрите «С телефона: http://192.168.x.x:3000» и на телефоне открывайте этот адрес.
   - **Точка доступа с ПК (часто надёжнее):** Параметры Windows → Сеть и Интернет → **Точка доступа для мобильных устройств** → включите, задайте имя и пароль. Подключите телефон к этой Wi‑Fi сети. Обычно IP ПК в такой сети — **192.168.137.1**. На телефоне откройте: `http://192.168.137.1:3000/client` и при необходимости `http://192.168.137.1:3000/api/health`.

5. **Разрешить Node по пути в брандмауэре.** Если порт открыт, но доступ всё равно блокируется, добавьте правило по программе (PowerShell от администратора):
   ```powershell
   $node = (Get-Command node).Source
   New-NetFirewallRule -DisplayName "Node.js Server" -Direction Inbound -Program $node -Action Allow -Profile Any
   ```

6. **Туннель — надёжный способ, если без туннеля таймаут.** Одна команда поднимает сервер и туннель:
   ```bash
   npm run tunnel
   ```
   В выводе найдите строку `your url is: https://xxxx.loca.lt`. **На ПК** откройте в браузере **https://xxxx.loca.lt/host** (экран ведущего). Создайте комнату — QR-код и ссылка в лобби будут вести на **https://xxxx.loca.lt/client?room=КОД**, так что игроки по скану QR или по ссылке попадут в игру через туннель. При первом заходе на *.loca.lt может появиться «Click to continue» — нажмите, затем откройте нужную страницу снова.

7. **Антивирус.** Касперский, Norton, Avast и др. часто имеют свой «сетевой экран». В настройках антивируса найдите раздел «Сеть» / «Firewall» и добавьте разрешение для Node.js или для порта 3000.

8. **Другой порт.** Если порт 3000 блокируется, попробуйте 8080 (в корне проекта в PowerShell: `$env:PORT=8080; npm run dev:server`). В консоли будет «С телефона: http://192.168.x.x:8080» — на телефоне откройте этот адрес.

## Роли

| Путь    | Назначение |
|--------|------------|
| `/`    | Главная, выбор роли |
| `/host`  | Экран ведущего: создание комнаты, лобби с QR, вопросы, результаты, таблица лидеров |
| `/client` | Экран игрока: ввод кода и ника, ответы A/B/C/D, результаты |
| `/admin`  | Создание и редактирование паков (вопросы и ответы в JSON) |

## Игровой цикл

1. **Ведущий** создаёт комнату → получает 4-буквенный код и ссылку для входа (можно показать QR).
2. **Игроки** заходят на `/client`, вводят код и ник, попадают в лобби.
3. Ведущий выбирает пак (или тест без пакa) и нажимает «Начать игру».
4. **Вопрос:** на ПК показывается вопрос и таймер; на телефонах — кнопки A, B, C, D. Ответы синхронизируются в реальном времени («Игрок X ответил»).
5. Ведущий нажимает «Показать ответ» (или ждёт таймер) → показываются правильный ответ и очки раунда.
6. «Следующий вопрос» — повтор до конца пака, затем итоговая таблица.

## Структура проекта

```
Box/
├── server.js          # Express + Socket.io, API паков, логика комнат
├── constants.js        # Состояния игры (LOBBY, QUESTION, RESULTS), события сокетов
├── games/              # JSON-паки викторин
│   ├── sample.json
│   └── media/          # медиа вопросов (фото, видео, аудио) по папкам паков
├── client/             # React (Vite)
│   ├── src/
│   │   ├── pages/      # Host, Client, Admin, Home
│   │   ├── hooks/      # useSocket
│   │   └── constants.js
│   └── ...
├── package.json
└── README.md
```

## Формат пака (JSON)

В `games/*.json`:

```json
{
  "title": "Название пака",
  "questions": [
    {
      "question": "Текст вопроса?",
      "options": ["Вариант A", "Вариант B", "Вариант C", "Вариант D"],
      "correctIndex": 0
    }
  ]
}
```

`correctIndex` — индекс правильного варианта (0 = A, 1 = B, 2 = C, 3 = D). Паки можно создавать и редактировать в админке `/admin`.

В вопросах можно указать медиа (опционально): **image**, **video**, **audio** — URL или путь к файлу (например после загрузки в админке путь вида `id-пака/имя-файла`). Файлы загружаются в `games/media/<id-пака>/` и отдаются по адресу `/media/...`.
